# ติดตั้งไลบรารีที่ต้องใช้สำหรับคลาสนี้ (รันคำสั่งเหล่านี้ใน terminal ก่อนใช้งาน)
# pip install psutil asyncio numpy

import asyncio
import psutil
import numpy as np
from collections import deque
import logging
from config import GlobalConfig

class IntelligentResourceManager:
    def __init__(self):
        self.cpu_usage = deque(maxlen=60)
        self.ram_usage = deque(maxlen=60)
        self.model_batch_sizes = {'qnt': 32, 'ddpg': 32, 'ssd': 32, 'evogan': 32, 'tft': 32, 'gnn': 32, 'madrl': 32, 'meta': 32}
        self.task_priorities = {'train': 0.7, 'predict': 0.2, 'data_fetch': 0.1}
        self.resource_lock = asyncio.Lock()

    async def monitor_resources(self):
        process = psutil.Process()
        while GlobalConfig.get('system_running'):
            self.cpu_usage.append(process.cpu_percent(interval=1))
            self.ram_usage.append(process.memory_info().rss / (1024 * 1024))
            if GlobalConfig.get('resource_adaptive'):
                await self.adjust_resources()
            await asyncio.sleep(60)

    async def adjust_resources(self, trader=None):
        async with self.resource_lock:
            avg_cpu = np.mean(self.cpu_usage) if self.cpu_usage else 50
            avg_ram = np.mean(self.ram_usage) if self.ram_usage else 1024
            if avg_cpu > (100 - GlobalConfig.get('min_cpu_idle_percent')) or avg_ram > (psutil.virtual_memory().total / (1024 * 1024) - GlobalConfig.get('min_ram_reserve_mb')):
                for model in self.model_batch_sizes:
                    self.model_batch_sizes[model] = max(1, int(self.model_batch_sizes[model] * 0.8))
                logging.info(f"ลด batch size เนื่องจาก CPU={avg_cpu:.1f}%, RAM={avg_ram:.1f}MB")
            elif avg_cpu < 50 and avg_ram < (psutil.virtual_memory().total / (1024 * 1024) * 0.5):
                for model in self.model_batch_sizes:
                    self.model_batch_sizes[model] = min(128, int(self.model_batch_sizes[model] * 1.2))
                logging.info(f"เพิ่ม batch size เนื่องจาก CPU={avg_cpu:.1f}%, RAM={avg_ram:.1f}MB")
            if trader:
                trader.resource_manager.model_batch_sizes = self.model_batch_sizes
